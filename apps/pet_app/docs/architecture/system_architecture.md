# Pet App V3 系统架构文档

## 概述
Pet App V3 采用分层模块化架构，实现了从插件系统到完整应用运行时的全栈解决方案。

## 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    Pet App V3 应用层                        │
├─────────────────────────────────────────────────────────────┤
│  Phase 4: 用户界面和体验优化                                │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│  │  首页仪表板      │ │   设置系统      │ │   桌宠系统      │ │
│  │ HomeDashboard   │ │ SettingsSystem  │ │ PetSystem       │ │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  Phase 3.3: 基础UI集成                                      │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│  │  主界面框架      │ │    导航系统      │ │  快捷键&手势    │ │
│  │ MainAppFramework│ │ NavigationManager│ │ ShortcutManager │ │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  Phase 3.2: 模块间通信协调                                   │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│  │  统一消息总线    │ │   事件路由      │ │   数据同步      │ │
│  │UnifiedMessageBus│ │ EventRouting    │ │ DataSyncManager │ │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  Phase 3.1: 应用生命周期管理                                │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│  │  生命周期管理    │ │   状态管理      │ │   模块加载      │ │
│  │AppLifecycleManager│ │ StateManager   │ │ ModuleLoader    │ │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  Phase 1-2: 插件系统 & 创意工坊                             │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│  │   插件系统      │ │   创意工坊      │ │   工具&游戏     │ │
│  │ PluginSystem    │ │CreativeWorkshop │ │   插件生态      │ │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## Phase 4 架构详解

### Phase 4.1: 首页仪表板开发

#### 设计理念
- **信息聚合**: 集中展示应用状态和用户数据
- **快速访问**: 提供常用功能的快捷入口
- **个性化**: 根据用户习惯提供个性化推荐

#### 核心组件
```
HomePage
├── 主页面容器和布局
├── 下拉刷新功能
├── 响应式网格布局
└── 状态管理集成

WelcomeHeader
├── 应用信息展示
├── 通知系统集成
├── 用户状态指示
└── 快速设置入口

QuickAccessPanel
├── 常用功能快捷方式
├── 动态操作按钮
├── 个性化推荐
└── 使用统计跟踪

ModuleStatusCard
├── 模块状态实时展示
├── 点击导航功能
├── 状态指示器
└── 模块信息展示

UserOverviewWidget
├── 用户使用统计
├── 成就系统展示
├── 最近项目列表
└── 个性化推荐
```

### Phase 4.2: 设置系统开发

#### 设计理念
- **分类管理**: 按功能分类组织设置项
- **实时生效**: 设置变更立即生效
- **数据持久化**: 设置数据自动保存和同步

#### 核心组件
```
SettingsSystem
├── 设置数据管理
├── 设置分类组织
├── 数据持久化
└── 设置同步机制

GeneralSettings
├── 语言和地区设置
├── 主题和外观设置
├── 自动保存配置
└── 启动行为设置

AppearanceSettings
├── 主题模式切换
├── 字体大小调节
├── 动画效果控制
└── 界面布局设置

NotificationSettings
├── 推送通知管理
├── 声音和振动设置
├── 免打扰模式
└── 通知分类管理

PrivacySettings
├── 数据收集控制
├── 分析和统计设置
├── 位置服务管理
└── 隐私保护选项

AdvancedSettings
├── 开发者选项
├── 调试功能开关
├── 性能监控设置
└── 实验性功能
```

### Phase 4.3: 桌宠系统核心实现

#### 设计理念
- **模块化架构**: 高内聚低耦合的组件设计
- **智能化系统**: 基于AI的行为决策和学习
- **数据驱动**: 完整的数据模型和状态管理
- **可扩展性**: 支持多桌宠和插件扩展

#### 核心组件
```
PetCoreSystem
├── 桌宠核心模型
├── 智能AI引擎
├── 生命周期管理
└── 服务层架构

桌宠核心模型
├── PetEntity - 桌宠实体模型
│   ├── 基础属性 (健康、能量、饥饿、快乐、清洁度)
│   ├── 状态管理 (心情、活动、状态)
│   ├── 生命周期 (出生时间、年龄、成长阶段)
│   └── JSON序列化支持
├── PetState - 桌宠状态管理
│   ├── 状态创建和更新
│   ├── 错误状态处理
│   └── 交互模式管理
├── PetBehavior - 桌宠行为模型
│   ├── 行为定义 (ID、名称、描述、优先级)
│   ├── 行为属性 (持续时间、标签、条件)
│   └── 行为统计追踪
└── BehaviorStatistics - 行为统计
    ├── 执行次数和成功率统计
    ├── 平均执行时间计算
    └── 总体统计分析

桌宠状态枚举系统
├── PetMood - 心情系统 (12种心情状态)
│   ├── 积极心情 (开心、兴奋、平静、爱心)
│   ├── 消极心情 (生气、悲伤、害怕、生病)
│   └── 中性心情 (困倦、饥饿、无聊、好奇)
├── PetActivity - 活动类型 (8种活动)
│   ├── 基础活动 (空闲、睡觉、吃饭)
│   ├── 娱乐活动 (玩耍)
│   ├── 学习活动 (学习、工作)
│   └── 社交活动 (运动、社交)
└── PetStatus - 生命状态 (15种状态)
    ├── 生命周期状态 (未出生、孵化中、幼体、成长中、成年)
    ├── 健康状态 (健康、疲倦、虚弱、生病、受伤、恢复中)
    └── 系统状态 (活跃、离线、维护中、已删除)

智能AI引擎
├── PetAIEngine - AI决策引擎
│   ├── 行为选择算法
│   ├── 状态评估机制
│   └── 随机性控制
├── 学习系统
│   ├── AI记忆模块
│   ├── 适应性调整
│   └── 个性化发展
└── 交互响应
    ├── 用户交互处理
    ├── 环境感知
    └── 情感表达

桌宠生命周期管理
├── PetLifecycleManager - 生命周期控制器
│   ├── 启动和停止管理
│   ├── 桌宠注册系统
│   └── 状态同步机制
├── 自动化系统
│   ├── 定时任务调度
│   ├── 状态衰减机制
│   └── 紧急处理
└── 事件系统
    ├── 生命周期事件
    ├── 用户通知
    └── 历史记录

桌宠服务层
├── PetService - 桌宠服务
│   ├── CRUD操作
│   ├── 状态管理
│   └── 批量操作
├── PetBehaviorService - 行为服务
│   ├── 行为管理
│   ├── 统计分析
│   └── 性能优化
└── PetDataService - 数据管理服务
    ├── 数据持久化
    ├── 数据导入导出
    └── 数据清理
```

## Phase 3 架构详解

### Phase 3.1: 应用生命周期管理

#### 设计理念
- **统一管理**: 集中管理应用的启动、暂停、恢复、停止等生命周期
- **状态持久化**: 自动保存和恢复应用状态
- **模块协调**: 协调各模块的加载顺序和依赖关系

#### 核心组件
```
AppLifecycleManager
├── 生命周期状态管理
├── 应用启动流程控制
├── 错误恢复机制
└── 状态变更通知

StateManager
├── 键值对状态存储
├── 类型安全的状态访问
├── 批量状态操作
└── 状态变更监听

ModuleLoader
├── 模块依赖解析
├── 动态模块加载
├── 模块生命周期管理
└── 加载状态监控
```

### Phase 3.2: 模块间通信协调

#### 设计理念
- **统一通信**: 所有模块通过统一消息总线通信
- **事件驱动**: 基于事件的松耦合架构
- **数据一致性**: 跨模块数据同步机制

#### 核心组件
```
UnifiedMessageBus
├── 消息发布/订阅
├── 请求/响应模式
├── 消息过滤和路由
└── 性能监控

EventRoutingRule
├── 路由规则定义
├── 消息匹配逻辑
├── 优先级处理
└── 动态路由更新

DataSyncManager
├── 多种同步策略
├── 冲突检测和解决
├── 增量同步优化
└── 同步状态监控
```

### Phase 3.3: 基础UI集成

#### 设计理念
- **模块化UI**: 每个功能模块独立的UI组件
- **统一导航**: 全局导航系统支持深度链接
- **无障碍友好**: 完整的无障碍功能支持

#### 核心组件
```
MainAppFramework
├── 应用主框架
├── 状态栏管理
├── 快速操作面板
└── 模块切换器

NavigationManager
├── 路由注册和管理
├── 深度链接处理
├── 页面转场动画
└── 导航历史管理

KeyboardShortcutManager
├── 快捷键注册
├── 冲突检测
├── 优先级处理
└── 帮助系统

AccessibilityNavigationManager
├── 无障碍功能管理
├── 语音导航提示
├── 焦点管理
└── 个性化设置
```

## 数据流架构

### 消息流向
```
用户操作 → UI组件 → NavigationManager → UnifiedMessageBus → 目标模块
                                    ↓
状态变更 ← StateManager ← DataSyncManager ← 模块响应
```

### 生命周期流向
```
应用启动 → AppLifecycleManager → ModuleLoader → 各模块初始化
                              ↓
应用运行 → 消息总线协调 → 模块间通信 → UI更新
                              ↓
应用关闭 → 状态保存 → 模块卸载 → 资源清理
```

## 设计原则

### 1. 分层解耦
- **表现层**: UI组件和用户交互
- **业务层**: 模块逻辑和数据处理
- **通信层**: 消息总线和事件路由
- **基础层**: 生命周期和状态管理

### 2. 插件化扩展
- 所有功能模块都可以作为插件动态加载
- 统一的插件接口和生命周期管理
- 插件间通过消息总线通信

### 3. 事件驱动
- 基于事件的松耦合架构
- 异步消息处理机制
- 事件优先级和过滤机制

### 4. 状态一致性
- 集中式状态管理
- 跨模块数据同步
- 冲突检测和解决

## 性能优化

### 1. 懒加载
- 模块按需加载
- 路由懒注册
- 资源延迟初始化

### 2. 内存管理
- 自动资源清理
- 状态缓存限制
- 弱引用机制

### 3. 通信优化
- 消息批处理
- 异步处理机制
- 性能监控和调优

## 扩展性设计

### 1. 新模块集成
```dart
// 1. 实现模块接口
class NewModule extends ModuleInterface {
  @override
  Future<void> initialize() async {
    // 模块初始化
  }
}

// 2. 注册到模块加载器
ModuleLoader.instance.registerModule('new_module', NewModule());

// 3. 配置消息路由
EventRoutingRule.register(
  id: 'new_module_events',
  targetModule: 'new_module',
  filter: (message) => message.action.startsWith('new_module_'),
);
```

### 2. 新UI组件集成
```dart
// 1. 注册路由
NavigationManager.instance.registerRoute(
  '/new_feature',
  (context, parameters) => NewFeatureWidget(parameters: parameters),
);

// 2. 注册快捷键
KeyboardShortcutManager.instance.registerShortcut(
  ShortcutEntry(
    id: 'open_new_feature',
    combination: ShortcutCombination.simple(key: LogicalKeyboardKey.keyN, ctrl: true),
    action: () async {
      await NavigationManager.instance.navigateTo('/new_feature');
      return true;
    },
  ),
);
```

## 版本演进

### Phase 1-2 (已完成)
- 插件系统核心架构
- 创意工坊功能实现
- 基础工具和游戏插件

### Phase 3 (已完成)
- 应用生命周期管理
- 模块间通信协调
- 基础UI集成和导航

### Phase 4 (已完成)
- ✅ Phase 4.1: 首页仪表板开发
- ✅ Phase 4.2: 设置系统开发
- ✅ Phase 4.3: 桌宠系统核心实现

### Phase 5 (规划中)
- 高级功能特性
- 第三方集成
- 云服务支持

## 技术栈

- **框架**: Flutter 3.x
- **语言**: Dart 3.x
- **架构**: 分层模块化 + 插件系统
- **通信**: 事件驱动 + 消息总线
- **状态**: 集中式状态管理
- **测试**: 单元测试 + 集成测试 (527个测试，100%通过率)
- **状态管理**: Riverpod响应式状态管理
